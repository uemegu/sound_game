<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rhythm Game</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #fff;
        font-family: Arial, sans-serif;
      }
      #menu {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
      #menu select,
      #menu button {
        margin: 10px;
        padding: 10px;
        font-size: 16px;
      }
      #game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        border: 1px solid #333;
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        background-color: #fff;
        visibility: hidden; /* 初期状態では非表示 */
      }
      .lane {
        border-left: 2px solid #ccc;
        position: relative;
      }
      .lane:last-child {
        border-right: 2px solid #ccc;
      }
      .note {
        position: absolute;
        width: 100%;
        background-color: #000;
        z-index: 1;
      }
      .hit-button {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 100px;
        background-color: #d8f2ff;
        opacity: 0.5;
        border: 2px solid #aaa;
        text-align: center;
        line-height: 60px;
        font-size: 18px;
        cursor: pointer;
        z-index: 2;
      }
      #back-to-top {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        background-color: #008cba;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        z-index: 1000;
        display: none;
      }
      .feedback {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 20px;
        font-weight: bold;
        color: #db3030;
        opacity: 1;
        animation: feedbackAnimation 1s ease-out forwards;
        pointer-events: none; /* クリックできないようにする */
      }
      @keyframes feedbackAnimation {
        0% {
          transform: translate(-50%, 0);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50px);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="menu">
      <h1>Rhythm Game</h1>
      <select id="track-select">
        <option value="track1">Track 1</option>
        <option value="track2">Track 2</option>
        <option value="track3">Track 3</option>
        <option value="track4">Track 4</option>
      </select>
      <button id="start-menu-button">Start Game</button>
    </div>

    <div id="game-container">
      <!-- レーンは key1 ~ key6 -->
      <div class="lane" data-key="key1">
        <div class="hit-button" data-key="key1"></div>
      </div>
      <div class="lane" data-key="key2">
        <div class="hit-button" data-key="key2"></div>
      </div>
      <div class="lane" data-key="key3">
        <div class="hit-button" data-key="key3"></div>
      </div>
      <div class="lane" data-key="key4">
        <div class="hit-button" data-key="key4"></div>
      </div>
      <div class="lane" data-key="key5">
        <div class="hit-button" data-key="key5"></div>
      </div>
      <div class="lane" data-key="key6">
        <div class="hit-button" data-key="key6"></div>
      </div>
    </div>

    <button id="back-to-top">Back</button>
    <audio id="audio"></audio>

    <script>
      const trackData = {
        track1: { mp3: "./data/1.mp3", json: "./data/1.json" },
        track2: { mp3: "./data/2.mp3", json: "./data/2.json" },
        track3: { mp3: "./data/3.mp3", json: "./data/3.json" },
        track4: { mp3: "./data/4.mp3", json: "./data/4.json" },
      };

      const menu = document.getElementById("menu");
      const trackSelect = document.getElementById("track-select");
      const startMenuButton = document.getElementById("start-menu-button");
      const gameContainer = document.getElementById("game-container");
      const backToTopButton = document.getElementById("back-to-top");
      const audio = document.getElementById("audio");

      let selectedTrack = trackData["track1"];
      let notes = [];
      let tempo = 120.0;
      let gameStartTime = null;
      let score = 0;

      // カウントダウン後に再生開始 => 3秒後
      const countdownMs = 3000;

      // ノートが下-100px に到達するちょうどの時刻 = note.start_msec
      // => そこに至る "アプローチ時間" を設ける (例: 1小節分)
      // => 例: 4拍子(4拍) => measureMs = (60000/tempo)*4
      function getApproachTime() {
        const beatsPerMeasure = 4;
        const measureMs = (60000 / tempo) * beatsPerMeasure;
        return measureMs; // 1小節分落とす
      }

      function getSpeed() {
        // 移動距離 = 画面上( y=0 ) -> 画面下 -100px
        const distance = window.innerHeight - 100;
        const approachMs = getApproachTime();
        return distance / approachMs; // px/ms
      }

      startMenuButton.addEventListener("click", () => {
        const selectedTrackKey = trackSelect.value;
        selectedTrack = trackData[selectedTrackKey];

        menu.style.display = "none";
        gameContainer.style.visibility = "visible";
        backToTopButton.style.display = "block";

        audio.src = selectedTrack.mp3;
      });

      backToTopButton.addEventListener("click", () => {
        menu.style.display = "block";
        gameContainer.style.visibility = "hidden";
        backToTopButton.style.display = "none";
        notes = [];
        score = 0;
        gameStartTime = null;
        document.querySelectorAll(".note").forEach((note) => note.remove());
        audio.pause();
        audio.currentTime = 0;
      });

      async function startGame() {
        score = 0;

        // JSONデータ読み込み
        const response = await fetch(selectedTrack.json);
        const jsonData = await response.json();

        tempo = jsonData.metadata.tempo || 120.0;
        notes = jsonData.notes;

        // 3秒後にオーディオ再生 => ノート時刻を +3000 シフト
        notes.forEach((note) => {
          note.start_msec += countdownMs;
          note.end_msec += countdownMs;
        });

        spawnNotes(notes);

        gameStartTime = performance.now();

        setTimeout(() => {
          audio.play().catch((e) => console.log(e));
        }, countdownMs - 500);

        requestAnimationFrame(gameLoop);
      }

      function spawnNotes(noteData) {
        const speed = getSpeed();
        const approachTime = getApproachTime();

        noteData.forEach((note) => {
          const lane = document.querySelector(`.lane[data-key="${note.type}"]`);
          if (!lane) return;
          if (!note.duration_msec) return;

          const noteElement = document.createElement("div");
          noteElement.classList.add("note");

          // duration_msec 分ノートを縦に伸ばす (お好みで調整)
          // ここでは "ノート長 = duration_msec * speed / 2" とか
          const noteHeight = Math.max(
            20,
            ((note.duration_msec || 0) * speed) / 2
          );
          noteElement.style.height = noteHeight + "px";

          // dataset に保存
          // note.start_msec => ノートが (window.innerHeight - 100) に到達する時刻
          noteElement.dataset.startMsec = note.start_msec;
          // ノートが画面最上部( y=0 )に現れるのは (start_msec - approachTime)
          // つまり approachTime ms 前から落ち始めるイメージ
          lane.appendChild(noteElement);
        });
      }

      function gameLoop() {
        if (!gameStartTime) return;
        updateNotes();
        requestAnimationFrame(gameLoop);
      }

      function updateNotes() {
        const elapsed = performance.now() - gameStartTime;
        const speed = getSpeed();
        const approachTime = getApproachTime();

        document.querySelectorAll(".note").forEach((note) => {
          const startMsec = parseInt(note.dataset.startMsec, 10);

          // t = (現在経過時間) - (ノートが下ラインに到達する時刻 - アプローチ時間)
          //   = elapsed - (startMsec - approachTime)
          // t < 0 => まだ画面外上にいる
          // t >= 0 => 画面内を落ちてくる
          const t = elapsed - (startMsec - approachTime);

          if (t < 0) {
            // まだ上の方 (画面外) にいる
            note.style.transform = `translateY(-15000px)`;
          } else {
            // y = speed * t
            // t=0 のとき y=0 => 画面上端
            // t=approachTime のとき => y= speed*approachTime = (window.innerHeight-100)
            const y = t * speed;
            if (y > window.innerHeight) {
              note.remove();
            } else {
              note.style.transform = `translateY(${y}px)`;
            }
          }
        });
      }

      // 打鍵(クリック)で判定
      document.querySelectorAll(".hit-button").forEach((button) => {
        button.addEventListener("click", () => {
          if (!gameStartTime) return;

          const laneKey = button.dataset.key;
          const lane = document.querySelector(`.lane[data-key="${laneKey}"]`);
          const notesInLane = lane.querySelectorAll(".note");
          if (notesInLane.length === 0) return;

          // 一番上にあるノートを対象
          const closestNote = notesInLane[0];
          const startMsec = parseInt(closestNote.dataset.startMsec, 10);

          const elapsed = performance.now() - gameStartTime;
          // 打鍵とノート到達タイミングのズレ
          const diff = Math.abs(elapsed - startMsec);

          let feedbackText = "Bad";
          if (diff <= 50) {
            score += 10;
            feedbackText = "Excellent";
          } else if (diff <= 100) {
            score += 5;
            feedbackText = "Great";
          } else if (diff <= 300) {
            score += 2;
            feedbackText = "Good";
          } else if (diff > 500) {
            return;
          }

          showFeedback(lane, feedbackText);
          closestNote.remove();
          console.log(`Hit! Score=${score}, diff=${diff}`);
        });
      });

      function showFeedback(lane, text) {
        const feedback = document.createElement("div");
        feedback.textContent = text;
        feedback.classList.add("feedback");
        lane.appendChild(feedback);
        setTimeout(() => feedback.remove(), 1000);
      }

      // Startボタン => ゲーム開始
      startMenuButton.addEventListener("click", startGame);
    </script>
  </body>
</html>
