<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Rhythm Game</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #fff;
        font-family: Arial, sans-serif;
      }
      #menu {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
      #menu select,
      #menu button {
        margin: 10px;
        padding: 10px;
        font-size: 16px;
      }
      #game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        border: 1px solid #333;
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        background-color: #fff;
        visibility: hidden; /* 初期状態では非表示 */
      }
      .lane {
        border-left: 2px solid #ccc;
        position: relative;
      }
      .lane:last-child {
        border-right: 2px solid #ccc;
      }
      .note {
        position: absolute;
        width: 100%;
        background-color: #000;
        z-index: 1;
      }
      .hit-button {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 100px;
        background-color: #d8f2ff;
        opacity: 0.5;
        border: 2px solid #aaa;
        text-align: center;
        line-height: 60px;
        font-size: 18px;
        cursor: pointer;
        z-index: 2;
      }
      #back-to-top {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        background-color: #008cba;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        z-index: 1000;
        display: none;
      }
      .feedback {
        position: absolute;
        bottom: 80px; /* ボタンの少し上 */
        left: 50%;
        transform: translateX(-50%);
        font-size: 20px;
        font-weight: bold;
        color: #db3030;
        opacity: 1;
        animation: feedbackAnimation 1s ease-out forwards;
        pointer-events: none; /* クリックできないようにする */
      }
      @keyframes feedbackAnimation {
        0% {
          transform: translate(-50%, 0);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50px);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="menu">
      <h1>Rhythm Game</h1>
      <select id="track-select">
        <option value="track1">Track 1</option>
        <option value="track2">Track 2</option>
        <option value="track3">Track 3</option>
        <option value="track4">Track 4</option>
      </select>
      <button id="start-menu-button">Start Game</button>
    </div>

    <div id="game-container">
      <!-- レーンは key1 ~ key6 -->
      <div class="lane" data-key="key1">
        <div class="hit-button" data-key="key1"></div>
      </div>
      <div class="lane" data-key="key2">
        <div class="hit-button" data-key="key2"></div>
      </div>
      <div class="lane" data-key="key3">
        <div class="hit-button" data-key="key3"></div>
      </div>
      <div class="lane" data-key="key4">
        <div class="hit-button" data-key="key4"></div>
      </div>
      <div class="lane" data-key="key5">
        <div class="hit-button" data-key="key5"></div>
      </div>
      <div class="lane" data-key="key6">
        <div class="hit-button" data-key="key6"></div>
      </div>
    </div>

    <button id="back-to-top">Back</button>
    <audio id="audio"></audio>

    <script>
      const trackData = {
        track1: { mp3: "./data/1.mp3", json: "./data/1.json" },
        track2: { mp3: "./data/2.mp3", json: "./data/2.json" },
        track3: { mp3: "./data/3.mp3", json: "./data/3.json" },
        track4: { mp3: "./data/4.mp3", json: "./data/4.json" },
      };

      const menu = document.getElementById("menu");
      const trackSelect = document.getElementById("track-select");
      const startMenuButton = document.getElementById("start-menu-button");
      const gameContainer = document.getElementById("game-container");
      const backToTopButton = document.getElementById("back-to-top");
      const audio = document.getElementById("audio");

      let selectedTrack = trackData["track1"];
      let notes = [];
      let tempo = 120.0;
      let gameStartTime = null;
      let score = 0;

      // --------------------------------------------------
      // カウントダウン後、音源再生開始から note.start_msec で
      //   => ノートが画面下 -100px に到達
      // approachTime = ノートが画面上から下 -100px に到達するまでの時間
      // --------------------------------------------------
      const approachTime = 2000; // 2秒で下まで到達するとする

      // ボタン: Start Game
      startMenuButton.addEventListener("click", () => {
        const selectedTrackKey = trackSelect.value;
        selectedTrack = trackData[selectedTrackKey];

        menu.style.display = "none";
        gameContainer.style.visibility = "visible";
        backToTopButton.style.display = "block";

        audio.src = selectedTrack.mp3;
      });

      // Backボタン
      backToTopButton.addEventListener("click", () => {
        menu.style.display = "block";
        gameContainer.style.visibility = "hidden";
        backToTopButton.style.display = "none";
        notes = [];
        score = 0;
        gameStartTime = null;
        document.querySelectorAll(".note").forEach((note) => note.remove());
        audio.pause();
        audio.currentTime = 0;
      });

      // ゲーム開始
      async function startGame() {
        score = 0;

        // JSONロード
        const response = await fetch(selectedTrack.json);
        const jsonData = await response.json();

        tempo = jsonData.metadata.tempo;
        notes = jsonData.notes;

        // 3秒カウントダウン後に曲を再生するために +3,000ms シフト
        // さらに approachTime (2秒) だけ上から降らせる時間を確保
        // => 実際には note.start_msec が「ノートが下 -100px に来る瞬間」
        // => そこに至る 2秒前に 画面外(上)に配置し始める
        notes.forEach((note) => {
          // 例: note.start_msec=1000 => 実際には (1000 - approachTime) ms に上端に居る
          note.start_msec += 3000;
          note.end_msec += 3000;
        });

        spawnNotes(notes);

        gameStartTime = performance.now();

        // 3秒後に再生
        setTimeout(() => {
          audio.play().catch((e) => console.log(e));
        }, 3000);

        requestAnimationFrame(gameLoop);
      }

      function gameLoop() {
        if (!gameStartTime) return;
        updateNotes();
        requestAnimationFrame(gameLoop);
      }

      // ノートが下 -100px (ヒットライン) に来る時刻 => note.start_msec
      // => その 2秒前 (approachTime=2000) に y= -ノート高さ付近
      // => speed = (window.innerHeight - 100) / approachTime
      function getSpeed() {
        // ノートが y=0 から y=(window.innerHeight-100) まで approachTime ms かける
        const distance = window.innerHeight - 100;
        return distance / approachTime; // px/ms
      }

      function spawnNotes(noteData) {
        noteData.forEach((note) => {
          const lane = document.querySelector(`.lane[data-key="${note.type}"]`);
          if (!lane) return;

          const noteElement = document.createElement("div");
          noteElement.classList.add("note");

          // ノート高さ: 単純に duration_msec * 0.1px とか。お好みで
          const noteHeight = Math.max(20, (note.duration_msec || 0) * 0.1);
          noteElement.style.height = noteHeight + "px";

          noteElement.dataset.startMsec = note.start_msec;
          noteElement.dataset.endMsec = note.end_msec;
          lane.appendChild(noteElement);
        });
      }

      function updateNotes() {
        const elapsed = performance.now() - gameStartTime;
        const speed = getSpeed();

        document.querySelectorAll(".note").forEach((note) => {
          const startMsec = parseInt(note.dataset.startMsec, 10);
          // このノートが「下 -100px に来る瞬間」が startMsec
          // なので startMsec - approachTime に 画面上( y=0付近 ) に居るイメージ
          // => y = speed * (elapsed - (startMsec - approachTime))
          const t = elapsed - (startMsec - approachTime);

          if (t < 0) {
            // まだ上の方(画面外)にいる
            note.style.transform = `translateY(-120px)`;
          } else {
            // 画面内に落ちてくる
            const y = t * speed;
            // y が (window.innerHeight - 100) を超える => 下に抜けた
            if (y > window.innerHeight) {
              note.remove();
            } else {
              note.style.transform = `translateY(${y}px)`;
            }
          }
        });
      }

      // 判定
      document.querySelectorAll(".hit-button").forEach((button) => {
        button.addEventListener("click", () => {
          if (!gameStartTime) return;

          const laneKey = button.dataset.key;
          const lane = document.querySelector(`.lane[data-key="${laneKey}"]`);
          const notesInLane = lane.querySelectorAll(".note");
          if (notesInLane.length === 0) return;

          const closestNote = notesInLane[0];
          const startMsec = parseInt(closestNote.dataset.startMsec, 10);

          const elapsed = performance.now() - gameStartTime;
          // diff=ノート理想タイミング(startMsec) と 現在時刻 のズレ
          const diff = Math.abs(elapsed - startMsec);

          let feedbackText = "Bad";
          if (diff <= 50) {
            score += 10;
            feedbackText = "Excellent";
          } else if (diff <= 100) {
            score += 5;
            feedbackText = "Great";
          } else if (diff <= 300) {
            score += 2;
            feedbackText = "Good";
          }

          showFeedback(lane, feedbackText);
          closestNote.remove();
          console.log(`Hit! Score: ${score}, diff=${diff}`);
        });
      });

      function showFeedback(lane, text) {
        const feedback = document.createElement("div");
        feedback.textContent = text;
        feedback.classList.add("feedback");
        lane.appendChild(feedback);

        setTimeout(() => {
          feedback.remove();
        }, 1000);
      }

      // スタートメニューボタンからゲーム開始
      startMenuButton.addEventListener("click", startGame);
    </script>
  </body>
</html>
